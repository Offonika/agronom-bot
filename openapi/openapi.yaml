openapi: 3.0.3

info:
  title: Agronom Bot Internal API
  version: "1.10.0"
  description: |
    Telegram-–±–æ—Ç ¬´–ö–∞—Ä–º–∞–Ω–Ω—ã–π –∞–≥—Ä–æ–Ω–æ–º¬ª ‚Äî API v1.10.0.
    Fixes: +signature, +UNAUTHORIZED, +monthly limits, +X-API-Ver usage, +multipart required, clarified dosage units, +X-User-ID header, +ask_expert endpoint, +protocol fields category/status/waiting_days, +assistant chat/confirm_plan.
  contact:
    name: Ivan Gromov
    url: https://github.com/agronom-bot
    email: i.gromov@agrostore.ru

servers:
  - url: https://api.agronom.local
    description: Production
  - url: https://staging.agronom.local
    description: Staging

security:
  - ApiKeyAuth: []

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
    HmacAuth:
      type: apiKey
      in: header
      name: X-Sign

  parameters:
    ApiVersionHeader:
      name: X-API-Ver
      in: header
      required: true
      schema:
        type: string
        enum: [v1]
    UserIdHeader:
      name: X-User-ID
      in: header
      required: true
      schema:
        type: integer

  schemas:
    DiagnoseRequestMultipart:
      type: object
      required: [image]
      properties:
        image:
          type: string
          format: binary
        prompt_id:
          type: string
          enum: [v1]
        crop_hint:
          type: string
          description: "–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞ –∫—É–ª—å—Ç—É—Ä—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, '—Ç–æ–º–∞—Ç')."

    DiagnoseRequestBase64:
      type: object
      required: [image_base64, prompt_id]
      properties:
        image_base64:
          type: string
          description: Base64-JPEG/PNG ‚â§ 2 MB
        prompt_id:
          type: string
          enum: [v1]
        crop_hint:
          type: string
          description: "–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞ –∫—É–ª—å—Ç—É—Ä—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, '—Ç–æ–º–∞—Ç')."

    DiagnoseResponse:
      type: object
      required: [crop, disease, confidence, roi]
      properties:
        crop:
          type: string
          example: apple
        crop_ru:
          type: string
          example: "—è–±–ª–æ–Ω—è"
        disease:
          type: string
          example: powdery_mildew
        disease_name_ru:
          type: string
          example: "–º—É—á–Ω–∏—Å—Ç–∞—è —Ä–æ—Å–∞"
        confidence:
          type: number
          format: float
          example: 0.87
        roi:
          type: number
          format: float
          example: 1.9
        reasoning:
          type: array
          items:
            type: string
          example:
            - "–ë–µ–ª—ã–π –Ω–∞–ª—ë—Ç –ø–æ –ø—Ä–æ–∂–∏–ª–∫–∞–º"
            - "–ü—è—Ç–Ω–∞ –Ω–∞ –≤–µ—Ä—Ö–Ω–∏—Ö –ª–∏—Å—Ç—å—è—Ö"
        treatment_plan:
          $ref: '#/components/schemas/TreatmentPlan'
        next_steps:
          $ref: '#/components/schemas/NextSteps'
        plan_missing_reason:
          type: string
          description: "–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –ø–ª–∞–Ω–∞ –ª–µ—á–µ–Ω–∏—è (–µ—Å–ª–∏ –º–æ–¥–µ–ª—å –µ–≥–æ –Ω–µ –ø—Ä–∏—Å–ª–∞–ª–∞)."
        need_reshoot:
          type: boolean
          description: "true, –µ—Å–ª–∏ –º–æ–¥–µ–ª—å –ø—Ä–æ—Å–∏—Ç –ø–µ—Ä–µ—Å–Ω—è—Ç—å —Ñ–æ—Ç–æ."
        reshoot_tips:
          type: array
          description: "–ù–∞–±–æ—Ä —Å–æ–≤–µ—Ç–æ–≤ –¥–ª—è –ø–µ—Ä–µ—Å—ä—ë–º–∫–∏."
          items:
            type: string
        need_clarify_crop:
            type: boolean
            description: "true, –µ—Å–ª–∏ –º–æ–¥–µ–ª—å —Ö–æ—á–µ—Ç —É—Ç–æ—á–Ω–∏—Ç—å –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º—É—é –∫—É–ª—å—Ç—É—Ä—É."
        clarify_crop_variants:
            type: array
            items:
              type: string
            description: "–°–ø–∏—Å–æ–∫ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –∫—É–ª—å—Ç—É—Ä—ã –Ω–∞ –≤—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."
        assistant_ru:
          type: string
          description: "–ì–æ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."
        assistant_followups_ru:
          type: array
          items:
            type: string
          description: "–ö–æ—Ä–æ—Ç–∫–∏–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ —Ç–∏–ø–æ–≤—ã–µ —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã."
        protocol_status:
          type: string
          example: "–ë–µ—Ç–∞"
        protocol:
          $ref: '#/components/schemas/ProtocolResponse'

    ProtocolResponse:
      type: object
      required: [id, product, dosage_value, dosage_unit, phi]
      properties:
        id:
          type: integer
          example: 1
        product:
          type: string
          example: –°–∫–æ—Ä 250 –≠–ö
        dosage_value:
          type: number
          example: 2
        dosage_unit:
          type: string
          enum: [ml_10l, g_per_l]
          example: ml_10l
        phi:
          type: integer
          example: 30
        category:
          type: string
          example: main
        status:
          type: string
          example: active
        waiting_days:
          type: integer
          example: 30

    PhotoItem:
      allOf:
        - $ref: '#/components/schemas/DiagnoseResponse'
        - type: object
          required: [id, ts]
          properties:
            id:
              type: integer
              example: 42
            ts:
              type: string
              format: date-time
              example: "2025-07-20T12:34:56Z"

    TreatmentPlan:
      type: object
      properties:
        product:
          type: string
          example: "–¢–æ–ø–∞–∑"
        substance:
          type: string
          example: "–î–∏–∞–∑–µ–Ω–∫–æ–Ω–æ–∑–æ–ª (—Ç—Ä–∏–∞–∑–æ–ª—ã)"
        dosage_value:
          type: number
          format: float
          example: 2.5
        dosage_unit:
          type: string
          example: "–º–ª/10–ª"
        dosage:
          type: string
          example: "2 –º–ª –Ω–∞ 10 –ª –≤–æ–¥—ã, –æ–ø—Ä—ã—Å–∫–∏–≤–∞–Ω–∏–µ –ø–æ –ª–∏—Å—Ç—É"
        method:
          type: string
          example: "–û–ø—Ä—ã—Å–∫–∏–≤–∞–Ω–∏–µ –ø–æ –ª–∏—Å—Ç—É"
        phi:
          type: string
          example: "30 –¥–Ω–µ–π"
        phi_days:
          type: integer
          example: 30
        safety:
          type: string
          example: "–ü–µ—Ä—á–∞—Ç–∫–∏, –æ—á–∫–∏, –Ω–µ —Ä–∞—Å–ø—ã–ª—è—Ç—å –ø—Ä–∏ –≤–µ—Ç—Ä–µ"
        safety_note:
          type: string
          example: "–†–∞–±–æ—Ç–∞–π –≤ –°–ò–ó, –≤–µ—Ç–µ—Ä <5 –º/—Å"

    NextSteps:
      type: object
      required: [reminder, green_window]
      properties:
        reminder:
          type: string
          example: "–î–æ–±–∞–≤—å –ø–æ–≤—Ç–æ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏ —á–µ—Ä–µ–∑ 7 –¥–Ω–µ–π –∏ –æ—Ç–º–µ—Ç—å PHI."
        green_window:
          type: string
          example: "–í—ã–±–µ—Ä–∏ –≤–µ—á–µ—Ä –±–µ–∑ –¥–æ–∂–¥—è –∏ –≤–µ—Ç—Ä–∞ >5 –º/—Å."
        cta:
          type: string
          example: "–î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É"

    PhotoHistoryItem:
      type: object
      required: [photo_id, ts, crop, disease, status, confidence, thumb_url]
      properties:
        photo_id:
          type: integer
          example: 1
        ts:
          type: string
          format: date-time
          example: "2025-07-20T12:34:56Z"
        crop:
          type: string
          example: apple
        disease:
          type: string
          example: scab
        status:
          type: string
          enum: [pending, ok, retrying, failed]
          example: ok
        confidence:
          type: number
          format: float
          example: 0.92
        thumb_url:
          type: string
          format: uri
          example: https://cdn.example/thumb1.jpg

    ListPhotosResponse:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/PhotoItem'
        next_cursor:
          type: string
          nullable: true
          description: "–ü–µ—Ä–µ–¥–∞–π—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ ?cursor=‚Ä¶ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã (—Ñ–æ—Ä–º–∞—Ç `<id>:<unix_ts>`)"

    PaymentWebhook:
      type: object
      required: [external_id, status, paid_at, signature]
      properties:
        external_id:
          type: string
        status:
          type: string
          enum: [success, fail, cancel, bank_error]
        paid_at:
          type: string
          format: date-time
        signature:
          type: string
          description: HMAC-SHA256 of payload

    AutopayWebhook:
      type: object
      required: [autopay_charge_id, binding_id, user_id, amount, status, charged_at, signature]
      properties:
        autopay_charge_id:
          type: string
          example: CHG-1
        binding_id:
          type: string
          example: BND-1
        user_id:
          type: integer
        amount:
          type: integer
        status:
          type: string
          enum: [success, fail, cancel, bank_error]
        charged_at:
          type: string
          format: date-time
        signature:
          type: string
          description: HMAC-SHA256 of payload

    AutopayCancelRequest:
      type: object
      required: [user_id]
      properties:
        user_id:
          type: integer

    PaymentCreateRequest:
      type: object
      required: [user_id, plan]
      properties:
        user_id:
          type: integer
        plan:
          type: string
          enum: [pro]
          example: pro
        months:
          type: integer
          default: 1
        autopay:
          type: boolean
          nullable: true
          description: Enable SBP Autopay binding

    PaymentStatusResponse:
      type: object
      required: [status]
      properties:
        status:
          type: string
          enum: [pending, success, fail, cancel, bank_error]
        pro_expires_at:
          type: string
          format: date-time
          nullable: true

    PhotoStatusResponse:
      type: object
      required: [status, updated_at]
      properties:
        status:
          type: string
          enum: [pending, ok, retrying, failed]
        updated_at:
          type: string
          format: date-time
        crop:
          type: string
        disease:
          type: string
        protocol:
          $ref: '#/components/schemas/ProtocolResponse'

    DiagnoseQueuedResponse:
      type: object
      required: [id, status]
      properties:
        id:
          type: integer
          example: 1
        status:
          type: string
          example: pending

    ErrorResponse:
      type: object
      required: [code, message]
      properties:
        code:
          type: string
          enum:
            [NO_LEAF, LIMIT_EXCEEDED, GPT_TIMEOUT, BAD_REQUEST, UNAUTHORIZED, UPGRADE_REQUIRED, TOO_MANY_REQUESTS, SERVICE_UNAVAILABLE, FORBIDDEN]
        message:
          type: string
    LimitReached:
      type: object
      required: [error, limit]
      properties:
        error:
          type: string
          example: limit_reached
        limit:
          type: integer
          example: 5
    PlanSessionUpsertRequest:
      type: object
      required: [token, diagnosis]
      properties:
        token:
          type: string
          example: mi0jzzh5i6ba7l
        diagnosis:
          type: object
          additionalProperties: true
          description: "–û—Ç–≤–µ—Ç diagnose API, —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –¥–ª—è –º–∞—Å—Ç–µ—Ä–∞ –ø–ª–∞–Ω–æ–≤."
        current_step:
          type: string
          example: choose_object
        state:
          type: object
          additionalProperties: true
          description: "–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–∞—Å—Ç–µ—Ä–∞ (–≤—ã–±–æ—Ä –æ–±—ä–µ–∫—Ç–∞, —Ç—Ä–∏–≥–≥–µ—Ä –∏ —Ç.–¥.)."
        recent_diagnosis_id:
          type: integer
          nullable: true
        object_id:
          type: integer
          nullable: true
        plan_id:
          type: integer
          nullable: true
        ttl_hours:
          type: integer
          nullable: true
          description: "–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ TTL (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –±–µ—Ä—ë—Ç—Å—è –∏–∑ PLAN_SESSION_TTL_H)."
    PlanSessionRecord:
      type: object
      required: [id, user_id, token, created_at, updated_at, expires_at, expired, current_step, state, diagnosis]
      properties:
        id:
          type: integer
          example: 5
        user_id:
          type: integer
          example: 42
        token:
          type: string
          example: mi0jzzh5i6ba7l
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time
        expired:
          type: boolean
        current_step:
          type: string
          example: time_picker
        state:
          type: object
          additionalProperties: true
        diagnosis:
          type: object
          additionalProperties: true
        recent_diagnosis_id:
          type: integer
          nullable: true
        object_id:
          type: integer
          nullable: true
        plan_id:
          type: integer
          nullable: true
    PlanSessionPatchRequest:
      type: object
      properties:
        diagnosis:
          type: object
          additionalProperties: true
        current_step:
          type: string
        state:
          type: object
          additionalProperties: true
        recent_diagnosis_id:
          type: integer
          nullable: true
        object_id:
          type: integer
          nullable: true
        plan_id:
          type: integer
          nullable: true
        ttl_hours:
          type: integer
          nullable: true

    AssistantChatRequest:
      type: object
      required: [message]
      properties:
        session_id:
          type: string
          example: "chat-6f7c"
        object_id:
          type: integer
          nullable: true
        message:
          type: string
          example: "–ß—Ç–æ –¥–µ–ª–∞—Ç—å —Å —Ç–æ–º–∞—Ç–∞–º–∏ –ø–æ—Å–ª–µ –¥–æ–∂–¥—è?"
        metadata:
          type: object
          properties:
            recent_diagnosis_id:
              type: integer
              nullable: true
            plan_session_id:
              type: integer
              nullable: true
            locale:
              type: string
              example: ru

    AssistantProposal:
      type: object
      required: [proposal_id, kind]
      properties:
        proposal_id:
          type: string
        kind:
          type: string
          enum: [plan, event, clarify]
        plan_payload:
          type: object
          description: "–ú–∞—à–∏–Ω–Ω—ã–π –ø–ª–∞–Ω (—Ç–æ—Ç –∂–µ —Ñ–æ—Ä–º–∞—Ç, —á—Ç–æ –≤ PlanSession), draft/proposed."
          additionalProperties: true
        suggested_actions:
          type: array
          items:
            type: string
            enum: [pin, ask_clarification, show_plans, open_logbook]

    AssistantChatResponse:
      type: object
      required: [assistant_message]
      properties:
        assistant_message:
          type: string
          example: "–ü—Ä–µ–¥–ª–∞–≥–∞—é –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–ª—è üçÖ –ì—Ä—è–¥–∫–∞ ‚Ññ2 –∏ –Ω–∞–ø–æ–º–Ω—é –∑–∞ —á–∞—Å."
        followups:
          type: array
          items:
            type: string
        proposals:
          type: array
          items:
            $ref: '#/components/schemas/AssistantProposal'

    AssistantConfirmRequest:
      type: object
      required: [proposal_id, object_id]
      properties:
        proposal_id:
          type: string
        object_id:
          type: integer
        preferred_time:
          type: string
          format: date-time
          nullable: true
        plan_session_id:
          type: integer
          nullable: true

    AssistantConfirmResponse:
      type: object
      required: [status]
      properties:
        status:
          type: string
          enum: [accepted, scheduled]
        plan_id:
          type: integer
          nullable: true
        event_ids:
          type: array
          items:
            type: integer
        reminder_ids:
          type: array
          items:
            type: integer

    PlanCreateStage:
      type: object
      properties:
        stage_id:
          type: integer
          nullable: true
        option_ids:
          type: array
          items:
            type: integer

    PlanCreateRequest:
      type: object
      required: [object_id, plan_payload]
      properties:
        object_id:
          type: integer
        case_id:
          type: integer
          nullable: true
        source:
          type: string
          example: assistant
        plan_payload:
          type: object
          additionalProperties: true

    PlanCreateResponse:
      type: object
      properties:
        plan_id:
          type: integer
          nullable: true
        stages:
          type: array
          items:
            $ref: '#/components/schemas/PlanCreateStage'
        errors:
          type: array
          items:
            type: string

    EventCreateRequest:
      type: object
      required: [stage_id]
      properties:
        stage_id:
          type: integer
        stage_option_id:
          type: integer
          nullable: true
        due_at:
          type: string
          format: date-time
          nullable: true
        slot_end:
          type: string
          format: date-time
          nullable: true
        reason:
          type: string
          nullable: true

    EventCreateResponse:
      type: object
      properties:
        event_ids:
          type: array
          items:
            type: integer
        reminder_ids:
          type: array
          items:
            type: integer

    AutoplanRequest:
      type: object
      required: [stage_id, stage_option_id]
      properties:
        stage_id:
          type: integer
        stage_option_id:
          type: integer
        min_hours_ahead:
          type: integer
          default: 2
        horizon_hours:
          type: integer
          default: 72

    AutoplanResponse:
      type: object
      properties:
        autoplan_run_id:
          type: integer
          nullable: true
        status:
          type: string
          example: pending

paths:
  /v1/assistant/chat:
    post:
      summary: Conversational assistant entrypoint
      operationId: assistantChat
      description: "–ü–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –∂–∏–≤–æ–≥–æ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞; —á–∞—Ç ‚Äî –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –¥–∞–Ω–Ω—ã–µ –æ—Å—Ç–∞—é—Ç—Å—è –≤ cases/plans/events."
      tags: [assistant]
      security:
        - ApiKeyAuth: []
      parameters:
        - $ref: '#/components/parameters/ApiVersionHeader'
        - $ref: '#/components/parameters/UserIdHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AssistantChatRequest'
      responses:
        '200':
          description: Assistant reply with proposals
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AssistantChatResponse'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v1/assistant/confirm_plan:
    post:
      summary: Persist assistant proposal into plan/events/reminders
      operationId: assistantConfirmPlan
      description: "–ü–æ –∫–ª–∏–∫—É ¬´üìå –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å¬ª —Å–æ–∑–¥–∞—ë—Ç/–æ–±–Ω–æ–≤–ª—è–µ—Ç plan + —Å–æ–±—ã—Ç–∏—è/–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è —á–µ—Ä–µ–∑ —Ç–µ –∂–µ —Å–µ—Ä–≤–∏—Å—ã, —á—Ç–æ –º–∞—Å—Ç–µ—Ä."
      tags: [assistant]
      security:
        - ApiKeyAuth: []
      parameters:
        - $ref: '#/components/parameters/ApiVersionHeader'
        - $ref: '#/components/parameters/UserIdHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AssistantConfirmRequest'
      responses:
        '200':
          description: Plan/events persisted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AssistantConfirmResponse'
        '400':
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v1/plans:
    post:
      summary: Create plan from plan_payload
      operationId: createPlan
      description: "–°–æ–∑–¥–∞—ë—Ç –ø–ª–∞–Ω –ø–æ plan_payload (assistant/master)."
      tags: [plans]
      security:
        - ApiKeyAuth: []
      parameters:
        - $ref: '#/components/parameters/ApiVersionHeader'
        - $ref: '#/components/parameters/UserIdHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PlanCreateRequest'
      responses:
        '200':
          description: Plan created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlanCreateResponse'
        '400':
          description: Bad payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v1/plans/{plan_id}/events:
    post:
      summary: Create event/reminder for plan
      operationId: createPlanEvent
      tags: [plans]
      security:
        - ApiKeyAuth: []
      parameters:
        - $ref: '#/components/parameters/ApiVersionHeader'
        - $ref: '#/components/parameters/UserIdHeader'
        - name: plan_id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EventCreateRequest'
      responses:
        '200':
          description: Event created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EventCreateResponse'
        '400':
          description: Bad payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v1/plans/{plan_id}/autoplan:
    post:
      summary: Enqueue autoplan run
      operationId: enqueueAutoplan
      tags: [plans]
      security:
        - ApiKeyAuth: []
      parameters:
        - $ref: '#/components/parameters/ApiVersionHeader'
        - $ref: '#/components/parameters/UserIdHeader'
        - name: plan_id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AutoplanRequest'
      responses:
        '202':
          description: Autoplan enqueued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AutoplanResponse'
        '400':
          description: Bad payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v1/ai/diagnose:
    post:
      summary: Diagnose plant disease
      operationId: diagnosePlant
      description: |
        Upload a leaf photo and get back the predicted crop,
        disease and confidence score. Supports multipart uploads
        via `image` field or JSON body with `image_base64`.
      tags: [diagnose]
      security:
        - ApiKeyAuth: []
      parameters:
        - $ref: '#/components/parameters/ApiVersionHeader'
        - $ref: '#/components/parameters/UserIdHeader'
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/DiagnoseRequestMultipart'
          application/json:
            schema:
              $ref: '#/components/schemas/DiagnoseRequestBase64'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DiagnoseResponse'
        '202':
          description: Image queued for processing
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DiagnoseQueuedResponse'
        '400':
          description: Bad image / bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '413':
          description: Image too large
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '402':
          description: Free quota exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LimitReached'
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Unexpected internal error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
      x-rateLimit:
        ip_limit: 30
        user_limit: 120
        window: minute

  /v1/plans/sessions:
    post:
      summary: Create or refresh plan wizard session state
      operationId: upsertPlanSession
      tags: [plans]
      security:
        - ApiKeyAuth: []
      parameters:
        - $ref: '#/components/parameters/ApiVersionHeader'
        - $ref: '#/components/parameters/UserIdHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PlanSessionUpsertRequest'
      responses:
        '200':
          description: Session stored
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlanSessionRecord'
        '400':
          description: Invalid payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    get:
      summary: Fetch the latest or token-specific plan wizard session
      operationId: getPlanSession
      tags: [plans]
      security:
        - ApiKeyAuth: []
      parameters:
        - $ref: '#/components/parameters/ApiVersionHeader'
        - $ref: '#/components/parameters/UserIdHeader'
        - name: token
          in: query
          required: false
          schema:
            type: string
            description: "–ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω—è—è —Å–µ—Å—Å–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."
        - name: include_expired
          in: query
          required: false
          schema:
            type: boolean
            default: false
        - name: plan_id
          in: query
          required: false
          schema:
            type: integer
            description: "–í–µ—Ä–Ω—É—Ç—å —Å–µ—Å—Å–∏—é, —Å–≤—è–∑–∞–Ω–Ω—É—é —Å –ø–ª–∞–Ω–æ–º (–≤–∑–∞–∏–º–æ–∏—Å–∫–ª—é—á–∞–µ—Ç—Å—è —Å token)."
      responses:
        '200':
          description: Session returned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlanSessionRecord'
        '404':
          description: Session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '410':
          description: Session expired (unless include_expired=true)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    delete:
      summary: Delete plan wizard session(s)
      operationId: deletePlanSession
      tags: [plans]
      security:
        - ApiKeyAuth: []
      parameters:
        - $ref: '#/components/parameters/ApiVersionHeader'
        - $ref: '#/components/parameters/UserIdHeader'
        - name: token
          in: query
          required: false
          schema:
            type: string
            description: "–ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω, —É–¥–∞–ª—è—é—Ç—Å—è –≤—Å–µ —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."
        - name: plan_id
          in: query
          required: false
          schema:
            type: integer
            description: "–£–¥–∞–ª–∏—Ç—å —Å–µ—Å—Å–∏–∏, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –ø–ª–∞–Ω–æ–º."

  /v1/plans/sessions/{session_id}:
    patch:
      summary: Update plan wizard session fields
      operationId: patchPlanSession
      tags: [plans]
      security:
        - ApiKeyAuth: []
      parameters:
        - $ref: '#/components/parameters/ApiVersionHeader'
        - $ref: '#/components/parameters/UserIdHeader'
        - name: session_id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PlanSessionPatchRequest'
      responses:
        '200':
          description: Updated session
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlanSessionRecord'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
      responses:
        '204':
          description: Deleted
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v1/photos:
    get:
      summary: List user‚Äôs photos (history)
      operationId: listPhotos
      description: List previously uploaded photos with pagination.
      tags: [photos]
      security:
        - ApiKeyAuth: []
      parameters:
        - $ref: '#/components/parameters/ApiVersionHeader'
        - $ref: '#/components/parameters/UserIdHeader'
        - name: limit
          in: query
          schema:
            type: integer
            default: 10
            maximum: 50
        - name: cursor
          in: query
          schema:
            type: string
            description: "–û—Ç–¥–∞—ë—Ç—Å—è –≤ –æ—Ç–≤–µ—Ç–µ –∫–∞–∫ `next_cursor` (—Ñ–æ—Ä–º–∞—Ç: `<id>:<unix_ts>`)"
      responses:
        '200':
          description: Paginated list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListPhotosResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v1/photos/history:
    get:
      summary: Photo history (offset)
      operationId: listPhotosHistory
      description: Return past photos ordered by ts DESC.
      tags: [photos]
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 10
            maximum: 50
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
        - name: user_id
          in: query
          schema:
            type: integer
          description: User ID (stub)
      responses:
        '200':
          description: List of history items
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PhotoHistoryItem'
              example:
                - photo_id: 1
                  ts: "2025-07-20T12:34:56Z"
                  crop: apple
                  disease: scab
                  status: ok
                  confidence: 0.92
                  thumb_url: https://cdn.example/1.jpg
                - photo_id: 2
                  ts: "2025-07-21T13:45:00Z"
                  crop: tomato
                  disease: blight
                  status: failed
                  confidence: 0.45
                  thumb_url: https://cdn.example/2.jpg

  /v1/photos/{photo_id}:
    get:
      summary: Get photo status
      description: Retrieve status and metadata of a previously uploaded photo.
      operationId: getPhotoStatus
      tags: [photos]
      security:
        - ApiKeyAuth: []
      parameters:
        - $ref: '#/components/parameters/ApiVersionHeader'
        - $ref: '#/components/parameters/UserIdHeader'
        - in: path
          name: photo_id
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Photo details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PhotoStatusResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Not found

  /v1/limits:
    get:
      summary: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–∏–µ –ª–∏–º–∏—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      operationId: getUserLimits
      description: Retrieve current monthly usage limits for the authenticated user.
      tags: [limits]
      security:
        - ApiKeyAuth: []
      parameters:
        - $ref: '#/components/parameters/ApiVersionHeader'
        - $ref: '#/components/parameters/UserIdHeader'
      responses:
        '200':
          description: –¢–µ–∫—É—â–∏–µ –ª–∏–º–∏—Ç—ã
          content:
            application/json:
              schema:
                type: object
                required: [limit_monthly_free, used_this_month]
                properties:
                  limit_monthly_free:
                    type: integer
                    example: 5
                  used_this_month:
                    type: integer
                    example: 3
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v1/payments/create:
    post:
      summary: Create SBP payment
      description: Initiate a new SBP transaction and return a URL for payment processing.
      operationId: createPayment
      tags: [payments]
      security:
        - ApiKeyAuth: []
      parameters:
        - $ref: '#/components/parameters/ApiVersionHeader'
        - $ref: '#/components/parameters/UserIdHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PaymentCreateRequest'
      responses:
        '200':
          description: Payment link
          content:
            application/json:
              schema:
                type: object
                required: [payment_id, url]
                properties:
                  payment_id:
                    type: string
                    example: 123e4567e89
                  url:
                    type: string
                    example: https://sbp.example/pay
                  autopay_binding_id:
                    type: string
                    nullable: true
                    description: Identifier of SBP Autopay binding
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v1/payments/{payment_id}:
    get:
      summary: Payment status
      description: Check the current status of a previously created SBP payment.
      operationId: getPaymentStatus
      tags: [payments]
      security:
        - ApiKeyAuth: []
      parameters:
        - $ref: '#/components/parameters/ApiVersionHeader'
        - $ref: '#/components/parameters/UserIdHeader'
        - in: path
          name: payment_id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Payment status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentStatusResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Not found

  /v1/payments/sbp/webhook:
    post:
      summary: SBP payment webhook
      operationId: handleSbpWebhook
      description: Process SBP payment callback and update payment status.
      tags: [payments]
      security:
        - HmacAuth: []
        - ApiKeyAuth: []
      parameters:
        - $ref: '#/components/parameters/ApiVersionHeader'
        - $ref: '#/components/parameters/UserIdHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PaymentWebhook'
      responses:
        '200':
          description: Accepted
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v1/payments/sbp/autopay/webhook:
    post:
      summary: SBP autopay webhook
      operationId: handleAutopayWebhook
      description: Process SBP Autopay callback and update payment status.
      tags: [payments]
      security:
        - HmacAuth: []
        - ApiKeyAuth: []
      parameters:
        - $ref: '#/components/parameters/ApiVersionHeader'
        - $ref: '#/components/parameters/UserIdHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AutopayWebhook'
      responses:
        '200':
          description: Accepted
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v1/payments/sbp/autopay/cancel:
    post:
      summary: Cancel SBP autopay
      operationId: cancelAutopay
      description: Disable SBP Autopay for the user.
      tags: [payments]
      security:
        - ApiKeyAuth: []
      parameters:
        - $ref: '#/components/parameters/ApiVersionHeader'
        - $ref: '#/components/parameters/UserIdHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AutopayCancelRequest'
      responses:
        '204':
          description: Autopay canceled
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v1/partner/orders:
    post:
      summary: Order deep-link callback (AgroStore)
      operationId: partnerOrderCallback
      description: Receive deep-link order info from partner AgroStore.
      tags: [partner]
      security:
        - HmacAuth: []
        - ApiKeyAuth: []
      parameters:
        - $ref: '#/components/parameters/ApiVersionHeader'
        - $ref: '#/components/parameters/UserIdHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [order_id, user_tg_id, protocol_id, price_kopeks, signature]
              properties:
                order_id:
                  type: string
                user_tg_id:
                  type: integer
                protocol_id:
                  type: integer
                price_kopeks:
                  type: integer
                signature:
                  type: string
                  description: HMAC-SHA256 –ø–æ —Ç–µ–ª—É –∑–∞–ø—Ä–æ—Å–∞
      responses:
        '202':
          description: Queued
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v1/ask_expert:
    post:
      summary: Queue question for expert
      operationId: askExpert
      description: Send a question to a human agronomist for review.
      tags: [expert]
      security:
        - ApiKeyAuth: []
      parameters:
        - $ref: '#/components/parameters/ApiVersionHeader'
        - $ref: '#/components/parameters/UserIdHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [question]
              properties:
                question:
                  type: string
      responses:
        '202':
          description: Queued
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

tags:
  - name: diagnose
    description: Disease recognition
  - name: photos
    description: Photo history
  - name: payments
    description: SBP integration
  - name: limits
    description: User usage limits
  - name: assistant
    description: Conversational assistant (—á–∞—Ç, tool-calls)
  - name: partner
    description: External partner callbacks
  - name: expert
    description: Human expert questions
