# –ö–∞—Ä–º–∞–Ω–Ω—ã–π –∞–≥—Ä–æ–Ω–æ–º ‚Äì Telegram Bot (MVP)

[![Python 3.11+](https://img.shields.io/badge/python-3.11%2B-blue)](https://www.python.org/downloads/release/python-3110/)
> –¢—Ä–µ–±—É–µ—Ç—Å—è Node.js 20+ –¥–ª—è —Ä–∞–±–æ—Ç—ã Telegram-–±–æ—Ç–∞ –∏ —Ç–µ—Å—Ç–æ–≤.

> –ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π AI-–±–æ—Ç –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –±–æ–ª–µ–∑–Ω–µ–π —Ä–∞—Å—Ç–µ–Ω–∏–π –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ –ø—Ä–æ—Ç–æ–∫–æ–ª—É –æ–±—Ä–∞–±–æ—Ç–∫–∏.  
> –í–µ—Ä—Å–∏—è API: **v1.10.0** | –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: –≤ –ø–∞–ø–∫–µ `docs/` | OpenAPI: `openapi/openapi.yaml`

---

## üì¶ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- üì∑ –ü—Ä–∏—ë–º —Ñ–æ—Ç–æ –ª–∏—Å—Ç—å–µ–≤ –∏ –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ GPT‚ÄëVision
- üß™ –í–æ–∑–≤—Ä–∞—Ç –¥–∏–∞–≥–Ω–æ–∑–∞: `{crop, disease, confidence, reasoning}`
- üß¥ –ü–ª–∞–Ω –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑ GPT: `treatment_plan {product, dosage, phi, safety}`
- ‚è∞ –ë–ª–æ–∫ `next_steps`: –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ, –∑–µ–ª—ë–Ω–æ–µ –æ–∫–Ω–æ, CTA –∏–∑ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
- üìã –ü—Ä–æ—Ç–æ–∫–æ–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑ —Ä–µ–µ—Å—Ç—Ä–∞: `{product, dosage_value, dosage_unit, phi}`
- üí¨ –ñ–∏–≤–æ–π —á–∞—Ç —Å –ò–ò‚Äë–∞–≥—Ä–æ–Ω–æ–º–æ–º: —Å–≤–æ–±–æ–¥–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã, –æ–±—Å—É–∂–¥–µ–Ω–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤, –∫–Ω–æ–ø–∫–∞ ¬´üìå –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å¬ª –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç—å –≤ case/plan/event + –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
- üïê –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ FREE_MONTHLY_LIMIT —Ñ–æ—Ç–æ/–º–µ—Å –Ω–∞ Free-—Ç–∞—Ä–∏—Ñ–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 5)
- üí≥ –ü—Ä–æ–¥–∞—ë—Ç Pro-–¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ –°–ë–ü –∑–∞ 199‚ÄØ‚ÇΩ/–º–µ—Å (Bot Payments 2.0)
- üí∏ Paywall –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ (–∫–æ–¥ 402)
- ‚è±Ô∏è –ë–æ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞ –∏ —É–≤–µ–¥–æ–º–ª—è–µ—Ç –æ–± —É—Å–ø–µ—Ö–µ –∏–ª–∏ –æ—à–∏–±–∫–µ
- üìä –£—á—ë—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —Ç–∞–±–ª–∏—Ü–µ `photo_usage`, CRON `5 0 1 * *` —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å—á—ë—Ç—á–∏–∫–∏
- üìà –¢–∞–±–ª–∏—Ü–∞ `plan_funnel_events` —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç —à–∞–≥–∏ –≤–æ—Ä–æ–Ω–∫–∏ (—Å–º. `docs/LOGGING.md`) –∏ –ø–æ–º–æ–≥–∞–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∫–æ–Ω–≤–µ—Ä—Å–∏—é ¬´–§–æ—Ç–æ ‚Üí –í—Ä–µ–º—è¬ª
- üìú –ò—Å—Ç–æ—Ä–∏—è —Å–Ω–∏–º–∫–æ–≤ (–ø–∞–≥–∏–Ω–∞—Ü–∏—è)
- üìÇ API `/v1/diagnoses/recent` –æ—Ç–¥–∞—ë—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–∏–∞–≥–Ω–æ–∑ (24‚ÄØ—á) –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
- üß≠ API `/v1/plans/sessions` –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å/–≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å —à–∞–≥–∏ –º–∞—Å—Ç–µ—Ä–∞ –ø–ª–∞–Ω–æ–≤ —Å TTL
- üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø–∞—Ä—Ç–Ω—ë—Ä–æ–º AgroStore
- üåç –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –ø–æ —Ä–µ–≥–∏–æ–Ω—É (Nominatim + Redis-–∫–µ—à) –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø—Ä–æ–≥–Ω–æ–∑–∞
- üîî –ê–≤—Ç–æ–ø–ª–∞–Ω–µ—Ä –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ—Ç, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã, –∏ –ø—Ä–æ—Å–∏—Ç –æ–±–Ω–æ–≤–∏—Ç—å –∏—Ö —á–µ—Ä–µ–∑ /location
- üïí –ê–≤—Ç–æ–ø–ª–∞–Ω–µ—Ä –ø—Ä–∏—Å—ã–ª–∞–µ—Ç –∫–∞—Ä—Ç–æ—á–∫—É ¬´–®–∞–≥‚ÄØ3/3¬ª —Å –ø–æ–¥–æ–±—Ä–∞–Ω–Ω—ã–º –æ–∫–Ω–æ–º –∏ –ø–æ–≥–æ–¥–Ω—ã–º–∏ –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏; –µ—Å–ª–∏ –æ—á–µ—Ä–µ–¥—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –±–æ—Ç —Å–æ–∑–¥–∞—ë—Ç fallback-—Å–ª–æ—Ç —Å –¥–µ—Ñ–æ–ª—Ç–Ω–æ–π –ø—Ä–∏—á–∏–Ω–æ–π –∏ —Ç–µ–º–∏ –∂–µ –∫–Ω–æ–ø–∫–∞–º–∏ `[–ü—Ä–∏–Ω—è—Ç—å] / [–í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–µ –≤—Ä–µ–º—è] / [–û—Ç–º–µ–Ω–∏—Ç—å]`
- üìã –†–∞–∑–¥–µ–ª ¬´–ú–æ–∏ –ø–ª–∞–Ω—ã¬ª –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–ª–∏–∂–∞–π—à–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (—Å —Ñ–∏–ª—å—Ç—Ä–æ–º –ø–æ –æ–±—ä–µ–∫—Ç–∞–º –∏ –∫–Ω–æ–ø–∫–æ–π ¬´–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë¬ª), –æ—Ç–¥–µ–ª—å–Ω—ã–π –±–ª–æ–∫ ¬´–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ¬ª —Å –±—ã—Å—Ç—Ä—ã–º–∏ –¥–µ–π—Å—Ç–≤–∏—è–º–∏ –∏ –¥–∞—ë—Ç –∫–Ω–æ–ø–∫–∏ `[‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ] [üîÅ –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏] [‚úñ –û—Ç–º–µ–Ω–∏—Ç—å] [üìã –û—Ç–∫—Ä—ã—Ç—å –ø–ª–∞–Ω]`
- üì£ –ï—Å–ª–∏ –ø—Ä–æ—Å—Ä–æ—á–∫–∏ –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è, –±–æ—Ç –ø—Ä–∏—Å—ã–ª–∞–µ—Ç push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å CTA ¬´üìã –ú–æ–∏ –ø–ª–∞–Ω—ã¬ª
- üéØ –ü—Ä–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –æ–±—ä–µ–∫—Ç–∞—Ö –±–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —á–∏–ø—ã –Ω–∞–¥ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π ‚Äî –≤—ã–±–æ—Ä —Ä–∞—Å—Ç–µ–Ω–∏—è –∑–∞–Ω–∏–º–∞–µ—Ç –æ–¥–∏–Ω –∫–ª–∏–∫
- üß≠ –í –º–µ–Ω—é Telegram –∑–∞–∫—Ä–µ–ø–ª–µ–Ω—ã –∫–æ–º–∞–Ω–¥—ã: `/new`, `/plans`, `/objects`
- üìò –ï—Å—Ç—å –æ–Ω–±–æ—Ä–¥–∏–Ω–≥/–¥–µ–º–æ-–ø–ª–∞–Ω: –ø–µ—Ä–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç 3 —à–∞–≥–∞, –ø—Ä–∏–º–µ—Ä –ø–ª–∞–Ω–∞ –∏ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø—Ä–æ –∫–Ω–æ–ø–∫–∏ ¬´–ù–∞–∑–∞–¥/–û—Ç–º–µ–Ω–∞¬ª
- üìç –ö–æ–º–∞–Ω–¥–∞ `/location` –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —É—á–∞—Å—Ç–∫–∞ (—Ç–æ—á–Ω–µ–µ –ø—Ä–æ–≥–Ω–æ–∑ ¬´–∑–µ–ª—ë–Ω—ã—Ö –æ–∫–æ–Ω¬ª)

---

### ‚è±Ô∏è –ê–≤—Ç–æ–ø–ª–∞–Ω –∏ fallback ¬´–®–∞–≥‚ÄØ3/3¬ª

1. –ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ (`pick_opt`) –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è `autoplan_run`: –≤–æ—Ä–∫–µ—Ä (Open‚ÄëMeteo + BullMQ) –∏—â–µ—Ç –æ–∫–Ω–æ –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –µ–≥–æ –≤ `treatment_slots`.
2. –ö–∞–∫ —Ç–æ–ª—å–∫–æ –æ–∫–Ω–æ –Ω–∞–π–¥–µ–Ω–æ, –±–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–∞—Ä—Ç–æ—á–∫—É:
   ```
   –®–∞–≥ 3/3. –ü—Ä–µ–¥–ª–∞–≥–∞—é –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–ª—è üçá –ï–∂–µ–≤–∏–∫–∞ ‚Äî –õ–∏—Å—Ç–æ–≤–∞—è –ø–æ–¥–∫–æ—Ä–º–∫–∞.

   üóì 12 –Ω–æ—è–±—Ä—è, 19:00‚Äì20:00

   –ü–æ—á–µ–º—É —ç—Ç–æ –æ–∫–Ω–æ:
   ‚Ä¢ –±–µ–∑ –¥–æ–∂–¥—è 12 —á
   ‚Ä¢ –≤–µ—Ç–µ—Ä –¥–æ 4 –º/—Å
   ‚Ä¢ +14‚Ä¶+16 ¬∞C
   ```
   –ö–Ω–æ–ø–∫–∏ `[–ü—Ä–∏–Ω—è—Ç—å] / [–í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–µ –≤—Ä–µ–º—è] / [–û—Ç–º–µ–Ω–∏—Ç—å]` —É–ø—Ä–∞–≤–ª—è—é—Ç —Å–ª–æ—Ç–æ–º –∏ –ª–æ–≥–∏—Ä—É—é—Ç `slot_confirmed`.
3. –ï—Å–ª–∏ –æ—á–µ—Ä–µ–¥—å/–≤–æ—Ä–∫–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã, `plan_pick` —Å—Ä–∞–∑—É —Å–æ–∑–¥–∞—ë—Ç fallback-—Å–ª–æ—Ç: –∫–∞—Ä—Ç–æ—á–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è ¬´–®–∞–≥‚ÄØ3/3¬ª, –Ω–æ reason –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º (¬´–ê–≤—Ç–æ–ø–ª–∞–Ω–µ—Ä —Å–µ–π—á–∞—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω‚Ä¶¬ª), —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∂–¥–∞–ª; —Å–æ–æ–±—â–µ–Ω–∏–µ `plan_autoplan_none` –¥–æ–ø–æ–ª–Ω–µ–Ω–æ –∫–Ω–æ–ø–∫–æ–π ¬´–ü–æ–¥–æ–±—Ä–∞—Ç—å –≤—Ä–µ–º—è –≤—Ä—É—á–Ω—É—é¬ª.
4. –ö–Ω–æ–ø–∫–∞ ¬´–í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–µ –≤—Ä–µ–º—è¬ª (–∏–ª–∏ fallback –∏–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è) –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Ä—É—á–Ω–æ–π –º–∞—Å—Ç–µ—Ä (–ø—Ä–µ—Å–µ—Ç—ã ¬´–°–µ–≥–æ–¥–Ω—è –≤–µ—á–µ—Ä–æ–º¬ª, ¬´–ó–∞–≤—Ç—Ä–∞ —É—Ç—Ä–æ–º¬ª, ¬´–í—ã–±—Ä–∞—Ç—å –¥–∞—Ç—É¬ª). –®–∞–≥ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ `plan_sessions` (`time_manual_prompt ‚Üí time_scheduled`), –ø–æ—ç—Ç–æ–º—É –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –∫–æ–º–∞–Ω–¥–æ–π `/plan_treatment` –±–æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É –∏–ª–∏ —Å–æ–æ–±—â–∞–µ—Ç, —á—Ç–æ –≤—Ä–µ–º—è —É–∂–µ –≤—ã–±—Ä–∞–Ω–æ.

---

## üí¨ –ñ–∏–≤–æ–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç

> **–î–æ—Å—Ç—É–ø:** AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è **Pro-–ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤** –∏–ª–∏ **beta-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**. Free-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç paywall —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –æ—Ñ–æ—Ä–º–∏—Ç—å Pro.

- –ù–∞–∂–º–∏—Ç–µ ¬´üí¨ –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É¬ª –ø–æ–¥ –∫–∞—Ä—Ç–æ—á–∫–æ–π –¥–∏–∞–≥–Ω–æ–∑–∞ –∏–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ `/assistant`, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —á–∞—Ç ‚Äî –±–æ—Ç –ø–æ–¥—Ç—è–Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–π –æ–±—ä–µ–∫—Ç –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–∏–∞–≥–Ω–æ–∑—ã/plans/events.
- –í–æ–ø—Ä–æ—Å—ã –ø–∏—à–∏—Ç–µ –≤ —Å–≤–æ–±–æ–¥–Ω–æ–π —Ñ–æ—Ä–º–µ. –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º –∏ –ø—Ä–∏–∫–ª–∞–¥—ã–≤–∞–µ—Ç `proposals[]` —Å –∫–Ω–æ–ø–∫–æ–π ¬´üìå –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å¬ª. –ü–æ–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ, –¥–∞–Ω–Ω—ã–µ –æ—Å—Ç–∞—é—Ç—Å—è –≤ —á–∞—Ç–µ; –ø–æ—Å–ª–µ –∫–ª–∏–∫–∞ –±–æ—Ç –≤—ã–∑—ã–≤–∞–µ—Ç `/v1/assistant/confirm_plan`, —Å–æ–∑–¥–∞—ë—Ç plan/events/reminders –∏ –ø—Ä–∏—Å—ã–ª–∞–µ—Ç CTA ¬´üìã –ü–æ–∫–∞–∑–∞—Ç—å –¥–Ω–µ–≤–Ω–∏–∫¬ª / ¬´üí¨ –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —á–∞—Ç—É¬ª.
- –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö (`OBJECT_NOT_FOUND`, `PRODUCT_FORBIDDEN`, `PHI_CONFLICT`, `WEATHER_UNAVAILABLE` –∏ –¥—Ä.) –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–µ –∂–µ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–µ userErrors, —á—Ç–æ –∏ –≤ –º–∞—Å—Ç–µ—Ä–µ –ø–ª–∞–Ω–æ–≤, —Ç–∞–∫ —á—Ç–æ UX –æ—Å—Ç–∞—ë—Ç—Å—è –µ–¥–∏–Ω—ã–º.

## üó£Ô∏è –¢–æ–Ω –∏ CTA

- GPT-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≥–æ–≤–æ—Ä–∏—Ç –¥—Ä—É–∂–µ–ª—é–±–Ω–æ (¬´–î–∞–≤–∞–π¬ª, ¬´–°–æ–≤–µ—Ç—É—é¬ª, ¬´–û–±—Ä–∞—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏–µ¬ª) –∏ –æ—Ç–≤–µ—á–∞–µ—Ç —á–∏—Å—Ç—ã–º JSON –±–µ–∑ fenced-–∫–æ–¥–∞.
- –ü—Ä–∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ ‚â• 0.6 CTA ‚Äî ¬´–î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É¬ª –∏–ª–∏ ¬´–í—ã–±—Ä–∞—Ç—å –æ–∫–Ω–æ¬ª; –ø—Ä–∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ < 0.6 –±–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–ª–æ–∫ ¬´–ü–µ—Ä–µ—Å—ä—ë–º–∫–∞ / —É—Ç–æ—á–Ω–∏—Ç—å –∫—É–ª—å—Ç—É—Ä—É¬ª —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ –∏ —Å—Å—ã–ª–∫–æ–π –Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫—É.
- –í –∫–∞–∂–¥–æ–π –∫–∞—Ä—Ç–æ—á–∫–µ –µ—Å—Ç—å —Ä–∞–∑–¥–µ–ª—ã ¬´üì∏ –î–∏–∞–≥–Ω–æ–∑¬ª, ¬´üß™ –ü–æ—á–µ–º—É —Ç–∞–∫¬ª, ¬´üß¥ –ü–ª–∞–Ω¬ª, ¬´‚è∞ –ß—Ç–æ –¥–∞–ª—å—à–µ¬ª –∏ –∫–Ω–æ–ø–∫–∏ ¬´–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å¬ª, ¬´–ü–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ PHI¬ª, ¬´PDF-–∑–∞–º–µ—Ç–∫–∞¬ª.

---

## üöÄ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

- Backend: **FastAPI** (–∏–ª–∏ Node.js)
- DB: **PostgreSQL**
- –•—Ä–∞–Ω–∏–ª–∏—â–µ: **S3 (VK S3 –∏–ª–∏ MinIO)**
- –û—á–µ—Ä–µ–¥—å: **Bull / Celery / Redis (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)**
- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞: **Prometheus, Grafana, Loki**
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: per-user `X-API-Key`, `X-API-Ver`, `X-User-ID`, `X-Req-Ts`, `X-Req-Nonce`, `X-Req-Sign`, `X-Req-Body-Sha256`, HMAC‚ÄëSHA256
- –ñ–∏–≤–æ–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç ‚Äî —Ç–æ–Ω–∫–∏–π —Å–ª–æ–π –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏–∏: —á–∞—Ç –æ—Å—Ç–∞—ë—Ç—Å—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º, –∞ ¬´–∏—Å—Ç–∏–Ω–∞¬ª —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ cases/plans/events –∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è—Ö —á–µ—Ä–µ–∑ —Ç–µ –∂–µ —Å–µ—Ä–≤–∏—Å—ã, —á—Ç–æ –∏ –º–∞—Å—Ç–µ—Ä –ø–æ —Ñ–æ—Ç–æ

---

## üîê –õ–∏–º–∏—Ç—ã –∏ –∑–∞—â–∏—Ç–∞

| –¢–∞—Ä–∏—Ñ      | –î–∏–∞–≥–Ω–æ–∑–æ–≤ –≤ –º–µ—Å—è—Ü | –ó–∞—â–∏—Ç–∞ |
|------------|-------------------|--------|
| Free       | FREE_MONTHLY_LIMIT (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 5) | `X-API-Key` + `X-API-Ver` + `X-User-ID` + `X-Req-*` |
| Pro        | ‚àû                 | ‚Äî      |

–í—Å–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ OpenAPI + Spectral.
–ü–æ–¥–ø–∏—Å–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ API: `X-Req-Ts` + `X-Req-Nonce` + `X-Req-Sign` (+ `X-Req-Body-Sha256` –¥–ª—è JSON) (HMAC‚ÄëSHA256 –ø–æ payload —Å user_id/ts/nonce/method/path/query/body_sha256).
–ü–æ–¥–ø–∏—Å–∏ –æ—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤ —á–µ—Ä–µ–∑ `X-Sign` + `signature` –≤ —Ç–µ–ª–µ (HMAC‚ÄëSHA256).
–£—á—ë—Ç –ª–∏–º–∏—Ç–∞ –≤–µ–¥—ë—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ `photo_usage` (user_id, month, used). –°–±—Ä–æ—Å —Å—á—ë—Ç—á–∏–∫–æ–≤
–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç –≤–æ—Ä–∫–µ—Ä `usage_reset.js` –ø–æ CRON `5 0 1 * *` (–ú–°–ö). –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏
–æ—à–∏–±–∫–∏ 402 –±–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç paywall —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –∫—É–ø–∏—Ç—å Pro.
–ì–ª–æ–±–∞–ª—å–Ω—ã–π rate-limit —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω —á–µ—Ä–µ–∑ Redis (`INCR`+`EXPIRE`): 30 req/–º–∏–Ω —Å –æ–¥–Ω–æ–≥–æ IP –∏ 120 req/–º–∏–Ω –Ω–∞ `user_id` (–¥–ª—è Pro –Ω–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π). IP –±–µ—Ä—ë—Ç—Å—è –∏–∑ `request.client.host` –∏–ª–∏ –ø–µ—Ä–≤–æ–≥–æ –∞–¥—Ä–µ—Å–∞ –≤ `X-Forwarded-For`, –µ—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–æ–∫—Å–∏ —É–∫–∞–∑–∞–Ω –≤ `TRUSTED_PROXIES`. –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –±–æ—Ç –ø–æ–ª—É—á–∞–µ—Ç 429 –∏ —Å–æ–±—ã—Ç–∏–µ —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –≤ –ª–æ–≥–∞—Ö.
–û—á–µ—Ä–µ–¥—å –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º `retry_diagnosis.js`
–ø–æ CRON –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `RETRY_CRON` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `0 1 * * *`) –∏
–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–¥–∞—á–∏ —Å –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–æ–º –∏–∑ `RETRY_CONCURRENCY` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `1`).
–ü–æ—Å–ª–µ —Ç—Ä—ë—Ö –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ (`RETRY_LIMIT=3`) —Å—Ç–∞—Ç—É—Å —Å–Ω–∏–º–∫–∞ –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ `failed`.
–†–æ—Ç–∞—Ü–∏—è —Å–µ–∫—Ä–µ—Ç–æ–≤ (`DB_URL`, `BOT_TOKEN_DEV`, `S3_KEY`) –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é
—Å–∫—Ä–∏–ø—Ç–æ–º `rotate_secrets.ts` (CRON `0 3 * * 0`), –∫–æ—Ç–æ—Ä—ã–π –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
—Å–µ–∫—Ä–µ—Ç–æ–≤ –≤—ã–ø–æ–ª–Ω—è–µ—Ç `kubectl rollout restart`.

---

## üìÇ –û—Å–Ω–æ–≤–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

| –ú–µ—Ç–æ–¥ | URL                       | –û–ø–∏—Å–∞–Ω–∏–µ                      |
|-------|---------------------------|-------------------------------|
| POST  | `/v1/ai/diagnose`         | –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ –Ω–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É |
| GET   | `/v1/photos`              | –ò—Å—Ç–æ—Ä–∏—è —Å–Ω–∏–º–∫–æ–≤               |
| GET   | `/v1/photos/{photo_id}`   | –°—Ç–∞—Ç—É—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–æ—Ç–æ         |
| GET   | `/v1/limits`              | –û—Å—Ç–∞—Ç–æ–∫ –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤  |
| GET   | `/v1/payments/{payment_id}` | –°—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞ –∏ —Å—Ä–æ–∫ PRO    |
| POST  | `/v1/payments/sbp/webhook`| Webhook –æ–ø–ª–∞—Ç—ã Pro            |
| POST  | `/v1/partner/orders`      | –ó–∞–∫–∞–∑ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞ –æ—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–∞  |

OpenAPI —Å–º. –≤ `openapi/openapi.yaml`

### –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞ `/v1/ai/diagnose`

`X-API-Key` ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∫–ª—é—á –∏–∑ `users.api_key` (–¥–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `test-api-key`).
–ü–æ–¥–ø–∏—Å—å: HMAC‚ÄëSHA256(`user_api_key`, JSON payload `{user_id, ts, nonce, method, path}`).

```bash
TS=$(date +%s)
NONCE=$(python - <<'PY'
import uuid
print(uuid.uuid4().hex)
PY
)
SIGN=$(python - <<PY
import hmac, hashlib, json, os
payload = {
  "user_id": 1,
  "ts": int("$TS"),
  "nonce": "$NONCE",
  "method": "POST",
  "path": "/v1/ai/diagnose",
  "query": "",
}
body_sha256 = hashlib.sha256(
    json.dumps(
        {"image_base64": "dGVzdA==", "prompt_id": "v1"},
        separators=(",", ":"),
        sort_keys=True,
        ensure_ascii=False,
    ).encode()
).hexdigest()
payload["body_sha256"] = body_sha256
body = json.dumps(payload, separators=(",", ":"), sort_keys=True).encode()
key = os.environ.get("API_KEY", "test-api-key").encode()
print("BODY_SHA256=" + body_sha256)
print(hmac.new(key, body, hashlib.sha256).hexdigest())
PY
)
```

```bash
curl -X POST http://localhost:8010/v1/ai/diagnose \
  -H "X-API-Key: $API_KEY" \
  -H "X-API-Ver: v1" \
  -H "X-User-ID: 1" \
  -H "X-Req-Ts: $TS" \
  -H "X-Req-Nonce: $NONCE" \
  -H "X-Req-Sign: $SIGN" \
  -H "X-Req-Body-Sha256: $BODY_SHA256" \
  -H "Content-Type: application/json" \
  -d '{"image_base64":"dGVzdA==","prompt_id":"v1"}'
```

–û—Ç–≤–µ—Ç:

```json
{
  "crop": "apple",
  "disease": "powdery_mildew",
  "confidence": 0.92,
  "roi": 1.9,
  "reasoning": "–ë–µ–ª—ã–π –º—É—á–Ω–∏—Å—Ç—ã–π –Ω–∞–ª—ë—Ç –Ω–∞ –º–æ–ª–æ–¥—ã—Ö –ª–∏—Å—Ç—å—è—Ö –∏ —Å–∫—Ä—É—á–∏–≤–∞–Ω–∏–µ –∫—Ä–∞—è.",
  "treatment_plan": {
    "product": "–¢–æ–ø–∞–∑",
    "dosage": "2 –º–ª –Ω–∞ 10 –ª –≤–æ–¥—ã (–æ–ø—Ä—ã—Å–∫–∏–≤–∞–Ω–∏–µ –ø–æ –ª–∏—Å—Ç—É)",
    "phi": "30 –¥–Ω–µ–π",
    "safety": "–ü–µ—Ä—á–∞—Ç–∫–∏ –∏ —Ä–µ—Å–ø–∏—Ä–∞—Ç–æ—Ä, –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –ø—Ä–∏ –≤–µ—Ç—Ä–µ"
  },
  "next_steps": {
    "reminder": "–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —á–µ—Ä–µ–∑ 7 –¥–Ω–µ–π –∏ –æ—Ç–º–µ—Ç–∏—Ç—å PHI",
    "green_window": "–í—ã–±–µ—Ä–∏ –≤–µ—á–µ—Ä –±–µ–∑ –¥–æ–∂–¥—è –∏ –≤–µ—Ç—Ä–∞ >5 –º/—Å",
    "cta": "–î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É"
  },
  "protocol_status": null,
  "protocol": {
    "product": "–°–∫–æ—Ä 250 –≠–ö",
    "dosage_value": 2.0,
    "dosage_unit": "ml_10l",
    "phi": 30
  }
}
```

---

## üß± –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

agronom-bot/
‚îú‚îÄ‚îÄ app/ # –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥
‚îÇ ‚îú‚îÄ‚îÄ controllers/ # –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã FastAPI
‚îÇ ‚îú‚îÄ‚îÄ models/ # Pydantic/SQLAlchemy —Å—Ö–µ–º—ã
‚îÇ ‚îî‚îÄ‚îÄ services/ # GPT, –ø–æ–¥–ø–∏—Å–∏, S3
‚îú‚îÄ‚îÄ docs/ # SRS, ADR, Test Plan –∏ –¥—Ä.
‚îú‚îÄ‚îÄ prompts/ # –ü—Ä–æ–º—Ç—ã –¥–ª—è Cursor/GPT
‚îú‚îÄ‚îÄ openapi/ # API —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è (OpenAPI.yaml)
‚îú‚îÄ‚îÄ migrations/ # Alembic
‚îú‚îÄ‚îÄ tests/ # –¢–µ—Å—Ç—ã (pytest)
‚îú‚îÄ‚îÄ .env.template # –ü—Ä–∏–º–µ—Ä –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îî‚îÄ‚îÄ README.md # –≠—Ç–æ—Ç —Ñ–∞–π–ª



## üõ†Ô∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫ –ª–æ–∫–∞–ª—å–Ω–æ

–ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω **Node.js 20+** (–±–æ—Ç –∏ –µ–≥–æ —Ç–µ—Å—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç optional chaining/ES2022). –ï—Å–ª–∏ —Å–∏—Å—Ç–µ–º–Ω—ã–π `node` –Ω–∏–∂–µ, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ LTS 20 –∏ –¥–æ–±–∞–≤—å—Ç–µ –µ–≥–æ –≤ `PATH` –∏–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ `npm test --prefix bot` —á–µ—Ä–µ–∑ –±–∏–Ω–∞—Ä–Ω–∏–∫ `node20`.

1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª —à–∞–±–ª–æ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥–æ–π `cp .env.template .env` –∏ —É–∫–∞–∂–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î –∏ S3. –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ –Ω—É–∂–Ω—ã (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∑–∞–¥–∞–π—Ç–µ `POSTGRES_PASSWORD` –≤ `.env`):

   ```env
   POSTGRES_USER=postgres
   POSTGRES_PASSWORD=your-postgres-password
   POSTGRES_DB=agronom
   POSTGRES_HOST=localhost
   POSTGRES_PORT=5432
   DATABASE_URL=postgresql://postgres:your-postgres-password@localhost:5432/agronom
   BOT_DATABASE_URL=postgresql://postgres:your-postgres-password@localhost:5432/agronom
API_BASE_URL=http://localhost:8010

   S3_BUCKET=agronom
   S3_ENDPOINT=http://localhost:9000
   S3_ACCESS_KEY=minio
   S3_SECRET_KEY=minio123
   REDIS_URL=redis://localhost:6379
   RETRY_CONCURRENCY=1
   RETRY_LIMIT=3
   ```

`DATABASE_URL` –∏ `BOT_DATABASE_URL` –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç —Ñ–æ—Ä–º–∞—Ç—ã `postgresql://` –∏
`postgresql+<driver>://` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `postgresql+psycopg://`). –°–∫—Ä–∏–ø—Ç
`migrate_safe.sh` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —Ç–∞–∫–∏–µ DSN –∫ –≤–∏–¥—É
`postgresql://` –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–¥–∞—á–µ–π –≤ `psql`.

`postgres` –∏ `api` ‚Äî —ç—Ç–æ –∏–º–µ–Ω–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ –≤ `docker-compose.yml`.
–û–Ω–∏ —Ä–∞–∑—Ä–µ—à–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ —Å–µ—Ç–∏ Docker Compose. –ï—Å–ª–∏ –∑–∞–ø—É—Å–∫–∞—Ç—å API –∏ –±–æ—Ç
–Ω–∞ —Ö–æ—Å—Ç‚Äë–º–∞—à–∏–Ω–µ –±–µ–∑ Docker, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `localhost`:

```env
BOT_DATABASE_URL=postgresql://postgres:postgres@localhost:5432/agronom
API_BASE_URL=http://localhost:8010
```

–ß—Ç–æ–±—ã –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ —Å–µ—Ä–≤–∏—Å–∞–º –ø–æ –∏–º–µ–Ω–∏, —Å–ø–µ—Ä–≤–∞ –ø–æ–¥–Ω–∏–º–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:

```bash
docker-compose up -d
# –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –¥–æ—Å—Ç—É–ø–Ω—ã DSN —Å –∏–º–µ–Ω–∞–º–∏ —Å–µ—Ä–≤–∏—Å–æ–≤
BOT_DATABASE_URL=postgresql://postgres:postgres@postgres:5432/agronom
API_BASE_URL=http://api:8010
```

–ï—Å–ª–∏ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è –æ—à–∏–±–∫–∏ DNS –≤—Ä–æ–¥–µ `EAI_AGAIN`, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ
–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—â–µ–Ω—ã, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `localhost`/`127.0.0.1` –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –≤–Ω–µ
Docker –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ—á–∏—Å—Ç–∏—Ç–µ DNS‚Äë–∫–µ—à (`sudo systemd-resolve --flush-caches`).

> ‚ÑπÔ∏è –ï—Å–ª–∏ –≤—ã –∑–∞–¥–∞—ë—Ç–µ `HTTP_PROXY`/`HTTPS_PROXY` (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á—Ç–æ–±—ã Telegram‚Äë–±–æ—Ç
> —Ö–æ–¥–∏–ª –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç), –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–ø–∏—à–∏—Ç–µ `NO_PROXY=localhost,127.0.0.1,api,bot,db,redis,minio,prometheus,loki,grafana`
> –∏–ª–∏ —Ä–∞—Å—à–∏—Ä—å—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ. –ò–Ω–∞—á–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã (MinIO, Postgres,
> Redis) –±—É–¥—É—Ç —Ö–æ–¥–∏—Ç—å —á–µ—Ä–µ–∑ –≤–Ω–µ—à–Ω–∏–π –ø—Ä–æ–∫—Å–∏ –∏ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å 502/timeout.

2. –°–æ–∑–¥–∞–π—Ç–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –ø–æ–¥ **Python 3.11+ (3.12 experimental)** (–≤ –Ω—ë–º —É–∂–µ –µ—Å—Ç—å SQLite 3.35+):

   ```bash
   python3.11 -m venv .venv
   source .venv/bin/activate
   ```

   –¢—Ä–µ–±—É–µ—Ç—Å—è SQLite –≤–µ—Ä—Å–∏–∏ **3.35+**, –∏–Ω–∞—á–µ –Ω–µ –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î.


**–ü–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è Node.js 18+** ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è Telegram‚Äë–±–æ—Ç–∞ –∏ —Ç–µ—Å—Ç–æ–≤.
–ü–æ–¥–ø—Ä–æ–µ–∫—Ç—ã `bot` –∏ `fastify` —Å–æ–¥–µ—Ä–∂–∞—Ç –ø–æ–ª–µ `"engines": { "node": ">=18" }` –∏
—Ñ–∞–π–ª `.npmrc` —Å `engine-strict=true`, –ø–æ—ç—Ç–æ–º—É `npm install` –ø—Ä–æ–≤–µ—Ä–∏—Ç –≤–µ—Ä—Å–∏—é Node.

3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∫–æ–º–∞–Ω–¥–æ–π `./.codex/setup.sh` –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞–∫–µ—Ç—ã –¥–ª—è —Ç–µ—Å—Ç–æ–≤ –∏–∑ `requirements-dev.txt`. –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Node-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (`spectral` –∏ –ø—Ä–æ—á–∏–µ) –∫–æ–º–∞–Ω–¥–æ–π `npm install`. –ö–æ–º–∞–Ω–¥—É `pip install -r ./requirements-dev.txt` –∑–∞–ø—É—Å–∫–∞–π—Ç–µ **–∏–∑ –∫–æ—Ä–Ω—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è**. –ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∑–∞–¥–∞–π—Ç–µ `DATABASE_URL` –∏ –ø—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏:

   ```bash
   ./.codex/setup.sh
   pip install -r ./requirements-dev.txt
   npm install
   export DATABASE_URL=sqlite:///./app.db  # –∏–ª–∏ –¥—Ä—É–≥–∞—è —Å—Ç—Ä–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
   # –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
   ./scripts/migrate_safe.sh
   # –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–ª–∞–Ω –±–µ–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
   ./scripts/migrate_safe.sh --dry-run
   ```
   –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –ë–î –ø–æ `DATABASE_URL`. –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
   `sqlite://`, –ø—Ä–æ–≤–µ—Ä–∫–∞ `psql` –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è, –∏ —Å—Ä–∞–∑—É –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è
   `alembic upgrade head`.
### üõ† Troubleshooting –º–∏–≥—Ä–∞—Ü–∏–π

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `DB_CREATE_ALL=1` —Å–æ–∑–¥–∞—ë—Ç —Ç–∞–±–ª–∏—Ü—ã –±–µ–∑ –∏—Å—Ç–æ—Ä–∏–∏ Alembic. –ï—Å–ª–∏ –±–∞–∑–∞ –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞ —Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –æ—à–∏–±–∫—É ¬´duplicate column name¬ª.

**–í–∞—Ä–∏–∞–Ω—Ç A.** –£–¥–∞–ª–∏—Ç–µ —Ñ–∞–π–ª –±–∞–∑—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, `app.db`) –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ `./scripts/migrate_safe.sh` –≤–Ω–æ–≤—å.  
**–í–∞—Ä–∏–∞–Ω—Ç B.** –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü—ã —É–∂–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å –∞–∫—Ç—É–∞–ª—å–Ω–æ–π —Å—Ö–µ–º–æ–π, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ `alembic stamp head`, –∞ –∑–∞—Ç–µ–º –ø—Ä–∏–º–µ–Ω—è–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏.

–¢–∞–∫ –±–∞–∑–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è —Å Alembic –∏ –¥–∞–ª—å–Ω–µ–π—à–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–π–¥—É—Ç –±–µ–∑ –æ—à–∏–±–æ–∫.

4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ API:

   ```bash
   uvicorn app.main:app --reload
   ```

5. –ó–∞–ø—É—Å—Ç–∏—Ç–µ Telegram‚Äë–±–æ—Ç–∞ (–Ω–µ –∑–∞–±—É–¥—å—Ç–µ —É–∫–∞–∑–∞—Ç—å —Ç–æ–∫–µ–Ω –∏ —Å—Å—ã–ª–∫—É –ø–∞—Ä—Ç–Ω—ë—Ä–∞ –≤ `.env`):
   **–¢—Ä–µ–±—É–µ—Ç—Å—è Node.js 18+**
   –í —Ñ–∞–π–ª `.env` –¥–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:

   - `BOT_TOKEN_PROD=–≤–∞—à_—Ç–æ–∫–µ–Ω_–±–æ—Ç–∞` (–¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞; –µ—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω, –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω `BOT_TOKEN_DEV`)
   - `BOT_TOKEN_DEV=–≤–∞—à_—Ç–æ–∫–µ–Ω_–±–æ—Ç–∞` (–¥–ª—è dev/stage)
   - `PARTNER_LINK_BASE=https://agrostore.ru/agronom`
   - `PAYWALL_ENABLED=true`  # –≤–∫–ª—é—á–∏—Ç—å –ø–æ–∫–∞–∑ paywall
   - `BOT_DATABASE_URL=postgresql://postgres:postgres@localhost:5432/agronom`  # —Å—Ç—Ä–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è –±–æ—Ç–∞ (–≤ Docker: postgres)
   - `API_BASE_URL=http://localhost:8010`  # –∞–¥—Ä–µ—Å API (–≤ Docker: http://api:8010)
   - `BOT_METRICS_PORT=9300`  # –ø–æ—Ä—Ç Prometheus-–º–µ—Ç—Ä–∏–∫ –±–æ—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 3000, –ø–æ–º–µ–Ω—è–π—Ç–µ –µ—Å–ª–∏ Grafana —É–∂–µ —Å–ª—É—à–∞–µ—Ç –Ω–∞ —ç—Ç–æ–º –ø–æ—Ä—Ç—É)
   - `FREE_PHOTO_LIMIT=5`  # —á–∏—Å–ª–æ –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö —Ñ–æ—Ç–æ –≤ –º–µ—Å—è—Ü –¥–ª—è Telegram-–±–æ—Ç–∞ ([–ø—Ä–∏–º–µ—Ä](.env.template#L89))
   - `TINKOFF_TERMINAL_KEY=your-terminal-key`
   - `TINKOFF_SECRET_KEY=your-secret-key`
   - `HMAC_SECRET_PARTNER=test-hmac-partner`  # –ø–æ–¥–ø–∏—Å—å AgroStore
   - `REFRESH_COLLATION_ON_START=1`  # –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ API –≤—ã–ø–æ–ª–Ω–∏—Ç ALTER DATABASE ‚Ä¶ REFRESH COLLATION VERSION (—É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ 0, –µ—Å–ª–∏ –Ω–µ—Ç –ø—Ä–∞–≤)

  –ë–æ—Ç –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ PostgreSQL –ø–æ DSN –∏–∑ `BOT_DATABASE_URL`.

   ```bash
   npm install --prefix bot
   node bot/index.js
   ```

   –ë–∞–∑–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã:

   - `/start` ‚Äî –ø–æ–¥—Å–∫–∞–∑–∫–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ –ª–∏—Å—Ç–∞
   - `/retry <id>` ‚Äî –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É
- –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–∏–∞–≥–Ω–æ–∑ –∏ –∫–Ω–æ–ø–∫—É —Å –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–º
- –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –±–æ—Ç —É–≤–µ–¥–æ–º–∏—Ç –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –∏ —Å—Ä–æ–∫–µ PRO

6. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∞–≤—Ç–æ–ø–ª–∞–Ω–µ—Ä ‚Äî –æ–Ω –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—á–µ—Ä–µ–¥—å BullMQ –∏ –ø–æ–¥–±–∏—Ä–∞–µ—Ç ¬´–∑–µ–ª—ë–Ω—ã–µ –æ–∫–Ω–∞¬ª –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –æ–ø—Ü–∏–π –≤ –ø–ª–∞–Ω–µ. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∑–∞–¥–∞–Ω—ã `BOT_DATABASE_URL`, `REDIS_URL`, `BOT_TOKEN_PROD` (–∏–ª–∏ `BOT_TOKEN_DEV`) –∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (`WEATHER_LAT`/`WEATHER_LON`):

   ```bash
   node worker/autoplan.js
   # –∏–ª–∏ –≤ Docker
   docker compose up -d autoplan
   ```

   –í Docker Compose —ç—Ç–æ—Ç –≤–æ—Ä–∫–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ–±—Ä–∞–∑ –∏–∑ `worker/Dockerfile` –∏ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ —Ç–æ–π –∂–µ –ë–î, —á—Ç–æ –∏ –±–æ—Ç.

### üìç –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —É—á–∞—Å—Ç–∫–∞

–ß—Ç–æ–±—ã –∞–≤—Ç–æ–ø–ª–∞–Ω–µ—Ä –ø–æ–¥–±–∏—Ä–∞–ª –æ–∫–Ω–∞ –ø–æ —Ä–µ–∞–ª—å–Ω–æ–π –ø–æ–≥–æ–¥–µ, —É–∫–∞–∂–∏—Ç–µ –ª–æ–∫–∞—Ü–∏—é –∫–∞–∂–¥–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞:

- –ö–æ–≥–¥–∞ –±–æ—Ç –ø—Ä–∏—Å—ã–ª–∞–µ—Ç –∫–∞—Ä—Ç–æ—á–∫—É ¬´–ù–µ –Ω–∞—à—ë–ª —Ç–æ—á–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã‚Ä¶¬ª, –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É `üìç –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è` –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–æ—á–∫—É —á–µ—Ä–µ–∑ –º–µ–Ω—é –≤–ª–æ–∂–µ–Ω–∏–π Telegram (`üìé ‚Üí –ì–µ–æ–ø–æ–∑–∏—Ü–∏—è` ‚Üí ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—É—â—É—é¬ª –∏–ª–∏ ¬´–í—ã–±—Ä–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ¬ª).
- –õ–∏–±–æ –≤–≤–µ–¥–∏—Ç–µ —Ç–æ—á–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–æ–º–∞–Ω–¥–æ–π `/location 55.7512 37.6184`.
- –ú–æ–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å –∞–¥—Ä–µ—Å —Ç–µ–∫—Å—Ç–æ–º ‚Äî –±–æ—Ç –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è –Ω–∞–π—Ç–∏ –µ–≥–æ —á–µ—Ä–µ–∑ –≥–µ–æ—Å–µ—Ä–≤–∏—Å.

–ü–æ–∫–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–µ –∑–∞–¥–∞–Ω—ã, –∞–≤—Ç–æ–ø–ª–∞–Ω–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–µ—Ñ–æ–ª—Ç –∏–∑ `.env`, –ø–æ—ç—Ç–æ–º—É –æ–∫–Ω–∞ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –±—É–¥—É—Ç –Ω–µ—Ç–æ—á–Ω—ã–º–∏.

7. –¢–µ—Å—Ç—ã –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –∫–æ–º–∞–Ω–¥–æ–π:

   ```bash
   pytest
   ```

   –ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è `DATABASE_URL` —Ç–µ—Å—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç
    SQLite —Ñ–∞–π–ª `./app.db`.

   –î–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤ –Ω—É–∂–Ω–∞ SQLite **3.35+** ‚Äì –Ω–∞ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏—è—Ö –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
   `RETURNING`, –∏ —á–∞—Å—Ç—å —Ç–µ—Å—Ç–æ–≤ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è –æ—à–∏–±–∫–æ–π.

    –¢–µ—Å—Ç—ã –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç —Ñ–∞–π–ª `.env`, —Ç–∞–∫ –∫–∞–∫ `Settings(_env_file=None)` –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤
    —Ö—Ä–∞–Ω–∏–ª–∏—â–µ. –õ–æ–∫–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤—Ä–æ–¥–µ `S3_ENDPOINT` –Ω–µ –ø–æ–≤–ª–∏—è—é—Ç –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç.

### –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –ë–î

–≠–Ω–¥–ø–æ–∏–Ω—Ç—ã FastAPI —Ä–∞–±–æ—Ç–∞—é—Ç –≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ. –ß—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
event loop, –æ–±–æ—Ä–∞—á–∏–≤–∞–π—Ç–µ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π `SessionLocal` –≤ `asyncio.to_thread` –∏–ª–∏
–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –¥–≤–∏–∂–æ–∫ SQLAlchemy.

```python
def _db_task():
    with db.SessionLocal() as session:
        session.add(obj)
        session.commit()

await asyncio.to_thread(_db_task)
```

7. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é OpenAPI –ª–∏–Ω—Ç–µ—Ä–æ–º Spectral:

   ```bash
   spectral lint -r .spectral.yaml openapi/openapi.yaml
   ```

8. –ë—ã—Å—Ç—Ä–æ –ø–æ–¥–Ω—è—Ç—å –≤—Å—é –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –º–æ–∂–Ω–æ –∫–æ–º–∞–Ω–¥–æ–π `docker-compose up -d`. –ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å Grafana –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ [http://localhost:3000](http://localhost:3000). –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å `admin`/`admin`. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —É–∫–∞–∂–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ `GF_SECURITY_ADMIN_USER` –∏ `GF_SECURITY_ADMIN_PASSWORD` –≤ `.env`.


### –ò–º–ø–æ—Ä—Ç –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∫–∏

–î–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–æ–∫ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —É—Ç–∏–ª–∏—Ç—É:

```bash
python -m app.services.protocol_importer <zip_url> --category main
```

–î–æ–±–∞–≤—å—Ç–µ —Ñ–ª–∞–≥ `--force`, —á—Ç–æ–±—ã –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ. –°–∫—Ä–∏–ø—Ç
—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç CSV –∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç —Ç–∞–±–ª–∏—Ü—ã `catalogs` –∏ `catalog_items`.
–í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ —É—Ç–∏–ª–∏—Ç–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –µ–∂–µ–º–µ—Å—è—á–Ω—ã–º CRON‚Äë–¥–∂–æ–±–æ–º –¥–ª—è –∞–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏
–ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤.

–ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –∫–∞—Ç–∞–ª–æ–≥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç, –∑–∞–¥–∞–π—Ç–µ –ø—É—Ç—å –∫
—Ñ–∞–π–ª—É –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è
`CATALOG_CA_BUNDLE`.  –ß—Ç–æ–±—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É TLS, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ
`CATALOG_SSL_VERIFY=false`. –û–±–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ `.env.template`.

### –ï–∂–µ–º–µ—Å—è—á–Ω—ã–µ –∑–∞–¥–∞—á–∏ CRON

- `python -m app.services.protocol_importer` ‚Äî –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–∞–±–ª–∏—Ü—ã `catalogs` –∏
  `catalog_items`.
- `usage_reset.js` ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å—á—ë—Ç—á–∏–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ `photo_usage` –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é
  `5 0 1 * *` (–ú–°–ö).

### ‚öôÔ∏è –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ Python 3.11+ (3.12 experimental)

1. –£–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ `.venv` (–µ—Å–ª–∏ –±—ã–ª–æ):

   ```bash
   rm -rf .venv
   ```

2. –ü–µ—Ä–µ—Å–æ–∑–¥–∞–π—Ç–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∏ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:

   ```bash
   python3.11 -m venv .venv
   source .venv/bin/activate
   ./.codex/setup.sh
   ```
üìñ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
–°–º–æ—Ç—Ä–∏ –≤ –ø–∞–ø–∫–µ docs/:

srs.md ‚Äî —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

adr.md ‚Äî –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

data_contract.md ‚Äî —Å—Ö–µ–º–∞ –ë–î

security_checklist.md ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

partner_agrostore.md ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–∞—Ä—Ç–Ω—ë—Ä–∞

[pricing.md](pricing.md) ‚Äî —Ç–∞—Ä–∏—Ñ—ã –∏ —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã
payment_flow.md ‚Äî –ø—Ä–æ—Ü–µ—Å—Å –æ–ø–ª–∞—Ç—ã –∏ webhook SBP
[docs/public_offer.md](docs/public_offer.md) ‚Äî –ø—É–±–ª–∏—á–Ω–∞—è –æ—Ñ–µ—Ä—Ç–∞
[privacy_policy.md](docs/privacy_policy.md) ‚Äî –ø–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏


## Release 1.0 maintenance

Bug fixes that must go into the `release/1.0.0` branch should be labeled `release-blocker` so they can be tracked before the final release.


## License

This project is licensed under the [MIT License](LICENSE).
