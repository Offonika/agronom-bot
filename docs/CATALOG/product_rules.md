# Catalog — Product Rules

Версия: 0.1 (13.11.2025)

## 1. Назначение

Справочник `product_rules` хранит, какие препараты допустимы для конкретной культуры, региона и стадии. Он используется:

- При нормализации планов (валидация product_code, PHI, доз).
- Для сортировки вариантов в UI (безопасность → PHI → стоимость).
- Для отметки `needs_review`, если препарат не найден или вне допуска.

## 2. Формат данных

MVP-поставка: CSV/JSON-файл `data/product_rules.csv` (путь задаётся ENV `CATALOG_IMPORT_PATH`).

Столбцы:

| column            | type     | description                                      |
|-------------------|----------|--------------------------------------------------|
| product_code      | string   | ключ препарата (совпадает с `products.product_code`) |
| product_name      | string   | отображаемое имя                                 |
| ai                | string   | действующее вещество                             |
| crop              | string   | культура («ежевика», «томат»)                    |
| region            | string   | регион/климатическая зона                        |
| usage_class       | enum     | fungicide/insecticide/growth_regulator           |
| dose_min          | number   | нижняя граница дозы                              |
| dose_max          | number   | верхняя граница                                  |
| dose_unit         | string   | л/га, г/10 л и т.п.                              |
| phi_days          | int      | срок ожидания                                    |
| safe_phase        | string   | стадия, для которой разрешён препарат            |
| priority          | int      | 0..100, чем выше — тем выше в списке             |
| is_allowed        | bool     | true, если прошёл проверку                       |
| notes             | string   | комментарии (например, «допустим аналог X»)      |

*JSON* эквивалент может содержать вложенный массив `aliases` (для маппинга объектных названий).

## 3. Правила ранжирования

1. **Допуск** — препараты с `is_allowed=false` скрываются до ручного подтверждения.
2. **Безопасность** — предпочтение препаратам с меньшим PHI и соответствием фазе (`safe_phase`).
3. **Региональность** — точное совпадение региона > fallback «RU».
4. **Стоимость** — если доступна цена из `products.metadata.price`, сортируем по возрастанию (при равном приоритете).

## 4. Needs Review

- Если план содержит препарат, которого нет в `product_rules` для выбранной культуры/региона, опция помечается `needs_review=true`.
- UI показывает баннер «Препарат не найден в каталоге — подтвердите вручную».
- После ручного подтверждения `manual_override` записывается в `stage_options` и попадает в журнал (см. `docs/LOGGING.md`).

## 5. Импорт и сидер

- Команда `python scripts/import_catalog.py --path $CATALOG_IMPORT_PATH` читает CSV/JSON, синхронизирует `products` и `product_rules`.
- Для локальной разработки достаточно 20–30 записей (томаты, яблоня, ежевика).
- Сидер должен быть идемпотентным: обновление записи производится по `product_code + crop + region`.

## 6. Взаимодействие с планом

- При выборе опции `stage_options.product_id` связывается с `products.id`.
- Из `product_rules` берём: рекомендованную дозу (если нет в пакете ИИ), PHI и список разрешённых аналогов.
- В ответах ИИ допускается `product_name` без кода — маппинг осуществляется по `product_name` и `ai` (с нормализацией регистра).
