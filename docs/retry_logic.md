# Retry Logic

Документ описывает внутреннюю очередь повторной диагностики и статусы изображений в таблице `photos`.

## Статусы `photos.status`

- **pending** – снимок сохранён, но диагностика не выполнена из‑за таймаута GPT.
- **retrying** – один из повторов завершился ошибкой, будет предпринята ещё одна попытка.
- **failed** – исчерпано количество попыток (по умолчанию 3), диагноз недоступен.
- **ok** – диагноз получен успешно и данные сохранены.

## Очередь `retry-diagnosis`

Фоновый скрипт [`worker/retry_diagnosis.js`](../worker/retry_diagnosis.js)
использует Redis и библиотеку Bull. Задание `retry` добавляется по крону
`0 1 * * *` и перебирает все записи со статусом `pending`. Для каждого
фото повторно вызывается GPT‑Vision. При успехе статус меняется на `ok`,
при ошибке — на `retrying`. Информация о количестве обработанных снимков
выводится в лог. Если попытка завершается ошибкой, счётчик `retry_attempts` увеличивается.
Как только он превысит `RETRY_LIMIT`, запись переводится в статус `failed`.
