# Руководство для дежурной смены (on-call)

Версия 1.0 — 2025‑07‑29

Данный документ описывает базовые правила работы дежурной смены проекта «Карманный агроном». Он предназначен для инженеров поддержки и разработчиков, ответственных за бесперебойную работу сервиса. Ниже вы найдёте инструкции по доступу к логам и метрикам, процедуру аварийного отката, контакты PagerDuty, а также разбор распространённых инцидентов.

## 1. Доступ к логам и метрикам

Сервис использует связку Grafana + Prometheus + Loki. Метрики приложений попадают в Prometheus, логи контейнеров отправляются в Loki. Дашборды находятся по адресу <https://grafana.example.com>. Для входа используйте корпоративный SSO. Разрешения на чтение метрик выдаются группе `agronom-sre`. Если доступ отсутствует, обратитесь к техлиду.

### 1.1 Основные дашборды

- **Diagnosis** — ключевые показатели работы эндпоинта `/v1/ai/diagnose`, очередь воркера и p95 времени обработки.
- **Payments** — статус платежей через СБП и время отклика вебхуков.
- **System Load** — ресурсы нод, CPU и RAM подов, состояние очереди Redis.

### 1.2 Поиск по логам

История логов в Loki хранится 30 дней. Для поиска выполните запрос в Grafana Explore:

```logql
{container="app"} |= "ERROR" | json | user_id="123"
```

Все логи структурированы в формате JSON. В поле `trace_id` хранится идентификатор запроса из бота, поэтому находите цепочку действий по нему. Для экспорта данных используйте кнопку **Download CSV**.

## 2. Аварийный откат

Откат требуется при критических ошибках после релиза: падение сервиса, массовые 5xx или невозможность принять оплату. Процесс выполняется через Helm, так как приложение развёрнуто в Kubernetes.

1. Убедитесь, что вы залогинились в кластер: `kubectl config use-context prod-cluster`.
2. Посмотрите список релизов Helm: `helm list -n agronom`.
3. Найдите предыдущую стабильную версию, например `agro-app-1.6.0`.
4. Выполните откат: `helm rollback agro-app 1` (где `1` — номер ревизии). Следите за логами подов `kubectl logs -f deploy/app`.
5. После успешного запуска убедитесь, что метрики и логи стабилизировались. Задокументируйте откат в канале `#ops-notify`.

Если база данных претерпела миграции и откат невозможен простым rollback, используйте `alembic downgrade` до предыдущего тега. Действия по изменению схемы должны быть согласованы с DBA.

## 3. Контакты PagerDuty

Приём звонков и алёртов осуществляет дежурный инженер, закреплённый в расписании PagerDuty. Расписание доступно по ссылке <https://pagerduty.example.com/schedule/agronom>. Номера телефонов и Telegram для экстренной связи:

- **Основной инженер** — Иван Петров, +7‑900‑555‑11‑22, tg: @petrov_oncall
- **Резервный инженер** — Мария Ким, +7‑900‑555‑33‑44, tg: @kim_oncall

Письма от PagerDuty приходят на адрес `ops@agronom.example.com`. При срабатывании алёрта звонок поступает на телефон и в Telegram-бот. Если вы не можете принять смену, заранее сообщите в `#ops-team` и обновите расписание.

## 4. Распространённые инциденты

Ниже собраны типовые проблемы, которые чаще всего происходят в продакшене, а также шаги по их быстрому устранению.

### 4.1 Блокировка базы данных

**Симптомы**: API перестаёт отвечать или выдаёт ошибки `deadlock detected`. В Grafana растёт метрика `db_lock_wait_seconds`.

**Действия**:

1. Зайдите в базу через `psql` и выполните `SELECT pid, query FROM pg_stat_activity WHERE wait_event_type='Lock';` чтобы увидеть блокирующие транзакции.
2. При необходимости завершите процесс: `SELECT pg_terminate_backend(<pid>);` — после согласования с владельцем транзакции.
3. Убедитесь, что проблемные запросы исправлены (обычно это длительные обновления данных). Если ситуация повторяется, откатите проблемный релиз.

### 4.2 Переполнение памяти Redis

**Симптомы**: растущая задержка очереди, ошибки `OOM command not allowed`. На дашборде `System Load` краснеет график `redis_memory_usage`.

**Действия**:

1. Проверить состояние ключей `INFO memory`. Убедитесь, что `used_memory` приближается к `maxmemory`.
2. Очистите неиспользуемые ключи командой `redis-cli FLUSHDB` или выборочно `DEL key`, если есть понимание, какие данные не важны.
3. Увеличьте лимит через переменную окружения `REDIS_MAXMEMORY` и перезапустите поды: `kubectl rollout restart deploy/worker`.
4. Добавьте алёрт на превышение 80 % памяти, чтобы своевременно реагировать в будущем.

### 4.3 Ошибки вебхуков оплаты

**Симптомы**: пользователи жалуются, что платежи зависают, а в логах `payments` появляются записи `signature mismatch` или `timeout`. Метрика `webhook_failure_total` растёт.

**Действия**:

1. Проверьте доступность платёжного провайдера командой `curl -I https://sbp.example.com/ping`. При недоступности сообщите в поддержку провайдера.
2. Убедитесь, что секрет `SBP_SIGN_SECRET` совпадает с настройками в личном кабинете. Несовпадение может произойти после ротации ключа.
3. Если проблема в нашем коде (неверная обработка подписи или таймаут), откатите последний релиз и перезапустите бота через `helm rollback` как описано выше.
4. Для всех непринятых вебхуков запустите повторную доставку: `python scripts/retry_webhooks.py --from 2025-07-28`.

## 5. Завершение инцидента

После устранения проблемы убедитесь, что алёрты перестали срабатывать. Создайте post‑mortem в Confluence и опишите:

- причину инцидента,
- шаги по устранению,
- время простой и затронутые клиенты,
- что улучшить, чтобы избежать повторения.

Разошлите короткое резюме в канал `#ops-notify` и поставьте задачу на исправление корневой причины в Jira.

При внесении изменений в данную инструкцию необходимо обновить номер версии и кратко описать, какие разделы изменились. Все правки проходят peer review перед мержем в `develop`.

